<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TAF Route Optimizer - Ottimizzatore di Percorsi TAF 2025</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        :root {
            --primary: #3498db;
            --secondary: #2980b9;
            --success: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --light: #ecf0f1;
            --dark: #2c3e50;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: var(--primary);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .flex-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .left-panel {
            flex: 1;
            min-width: 300px;
        }
        
        .right-panel {
            flex: 2;
            min-width: 300px;
        }
        
        .card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .card-title {
            font-size: 18px;
            margin-bottom: 15px;
            color: var(--dark);
            border-bottom: 2px solid var(--light);
            padding-bottom: 10px;
        }
        
        #map {
            height: 500px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: var(--secondary);
        }
        
        .btn-success {
            background-color: var(--success);
        }
        
        .btn-success:hover {
            background-color: #27ae60;
        }
        
        .btn-danger {
            background-color: var(--danger);
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-warning {
            background-color: var(--warning);
        }
        
        .btn-warning:hover {
            background-color: #e67e22;
        }
        
        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: var(--light);
            font-weight: 600;
        }
        
        tr:hover {
            background-color: #f9f9f9;
        }
        
        .error-box {
            background-color: #fce4e4;
            border-left: 4px solid var(--danger);
            padding: 12px;
            margin-bottom: 15px;
            color: #a94442;
            border-radius: 4px;
            display: none;
        }
        
        .success-box {
            background-color: #d4edda;
            border-left: 4px solid var(--success);
            padding: 12px;
            margin-bottom: 15px;
            color: #155724;
            border-radius: 4px;
            display: none;
        }
        
        .info-box {
            background-color: #e3f2fd;
            border-left: 4px solid var(--primary);
            padding: 12px;
            margin-bottom: 15px;
            color: var(--secondary);
            border-radius: 4px;
        }
        
        .result-card {
            background-color: #f1f9f1;
            border-left: 4px solid var(--success);
        }
        
        .hidden {
            display: none;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 600px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: black;
        }
        
        .tab-container {
            margin-top: 20px;
        }
        
        .tab-buttons {
            display: flex;
            border-bottom: 1px solid #ddd;
        }
        
        .tab-button {
            padding: 10px 15px;
            background-color: #f1f1f1;
            border: none;
            cursor: pointer;
            border-radius: 4px 4px 0 0;
            margin-right: 5px;
        }
        
        .tab-button.active {
            background-color: var(--primary);
            color: white;
        }
        
        .tab-content {
            display: none;
            padding: 15px;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .qr-code {
            text-align: center;
            margin: 20px 0;
        }
        
        .qr-code img {
            max-width: 200px;
            height: auto;
        }
        
        .instruction-step {
            margin-bottom: 15px;
            padding-left: 20px;
            position: relative;
        }
        
        .instruction-step:before {
            content: "•";
            position: absolute;
            left: 0;
            color: var(--primary);
            font-weight: bold;
        }
        
        .platform-instructions {
            margin-top: 15px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 4px;
        }
        
        .platform-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--dark);
        }
        
        @media (max-width: 768px) {
            .flex-container {
                flex-direction: column;
            }
            
            #map {
                height: 350px;
            }
            
            .btn-group {
                flex-wrap: wrap;
            }
            
            .modal-content {
                width: 95%;
                margin: 5% auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>TAF Route Optimizer - Ottimizzatore di Percorsi TAF 2025</h1>
            <p>Ottimizza il tuo percorso utilizzando l'algoritmo del commesso viaggiatore</p>
        </header>
        
        <div id="error-box" class="error-box"></div>
        <div id="success-box" class="success-box"></div>
        
        <div class="flex-container">
            <div class="left-panel">
                <div class="card">
                    <h2 class="card-title">Aggiungi Punti</h2>
                    
                    <div class="form-group">
                        <label for="csv-file">Importa da CSV:</label>
                        <input type="file" id="csv-file" accept=".csv">
                    </div>
                    
                    <div class="form-group">
                        <label for="point-name">Nome del punto:</label>
                        <input type="text" id="point-name" placeholder="Es. Casa">
                    </div>
                    
                    <div class="form-group">
                        <label for="point-lat">Latitudine:</label>
                        <input type="number" id="point-lat" step="0.000001" placeholder="Es. 45.4642">
                    </div>
                    
                    <div class="form-group">
                        <label for="point-lon">Longitudine:</label>
                        <input type="number" id="point-lon" step="0.000001" placeholder="Es. 9.1900">
                    </div>
                    
                    <div class="btn-group">
                        <button id="add-point" class="btn-success">Aggiungi Punto</button>
                        <button id="add-gps" class="btn-warning">Usa Posizione GPS</button>
                    </div>
                    
                    <div class="form-group" style="margin-top: 20px;">
                        <label for="address">Cerca indirizzo:</label>
                        <input type="text" id="address" placeholder="Es. Via Roma 1, Milano">
                    </div>
                    
                    <div class="btn-group">
                        <button id="geocode-address">Geocodifica Indirizzo</button>
                        <button id="add-geocoded-point" class="btn-success" disabled>Aggiungi Punto Geocodificato</button>
                    </div>
                </div>
                
                <div class="card">
                    <h2 class="card-title">Ottimizzazione</h2>
                    
                    <div class="form-group">
                        <label for="start-point">Punto di partenza:</label>
                        <select id="start-point">
                            <option value="">Seleziona un punto di partenza</option>
                        </select>
                    </div>
                    
                    <button id="optimize-route">Ottimizza Percorso</button>
                    
                    <div id="result-info" class="info-box hidden" style="margin-top: 15px;">
                        <p>Distanza totale: <span id="total-distance">0</span> km</p>
                    </div>
                </div>
                
                <div class="card">
                    <h2 class="card-title">Esporta</h2>
                    
                    <div class="btn-group">
                        <button id="export-kml" disabled>Esporta KML</button>
                        <button id="export-gpx" disabled>Esporta GPX</button>
                        <button id="show-export-help" disabled>Guida all'importazione</button>
                    </div>
                </div>
            </div>
            
            <div class="right-panel">
                <div class="card">
                    <h2 class="card-title">Mappa</h2>
                    <div id="map"></div>
                </div>
                
                <div class="card">
                    <h2 class="card-title">Punti Inseriti</h2>
                    <div class="table-responsive">
                        <table id="points-table">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Latitudine</th>
                                    <th>Longitudine</th>
                                    <th>Azioni</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- I punti verranno aggiunti qui dinamicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal per l'esportazione -->
    <div id="export-modal" class="modal">
        <div class="modal-content">
            <span class="close" id="close-export-modal">&times;</span>
            <h2>Esporta Percorso</h2>
            
            <div class="tab-container">
                <div class="tab-buttons">
                    <button class="tab-button active" data-tab="kml-tab">KML</button>
                    <button class="tab-button" data-tab="gpx-tab">GPX</button>
                    <button class="tab-button" data-tab="help-tab">Guida all'importazione</button>
                </div>
                
                <div id="kml-tab" class="tab-content active">
                    <p>File KML per Google Maps e Google Earth:</p>
                    <div class="form-group">
                        <textarea id="kml-textarea" readonly></textarea>
                    </div>
                    <div class="btn-group">
                        <button id="copy-kml">Copia negli Appunti</button>
                        <button id="download-kml">Scarica File KML</button>
                    </div>
                </div>
                
                <div id="gpx-tab" class="tab-content">
                    <p>File GPX per app di navigazione e fitness:</p>
                    <div class="form-group">
                        <textarea id="gpx-textarea" readonly></textarea>
                    </div>
                    <div class="btn-group">
                        <button id="copy-gpx">Copia negli Appunti</button>
                        <button id="download-gpx">Scarica File GPX</button>
                    </div>
                </div>
                
                <div id="help-tab" class="tab-content">
                    <h3>Come importare il percorso</h3>
                    
                    <div class="platform-instructions">
                        <div class="platform-title">Google My Maps (metodo universale)</div>
                        <div class="instruction-step">Vai a <a href="https://mymaps.google.com" target="_blank">Google My Maps</a></div>
                        <div class="instruction-step">Accedi con il tuo account Google</div>
                        <div class="instruction-step">Clicca su "Crea una nuova mappa"</div>
                        <div class="instruction-step">Clicca su "Importa" sotto il titolo "Mappa senza titolo"</div>
                        <div class="instruction-step">Seleziona il file KML o GPX scaricato</div>
                        
                        <div class="qr-code">
                            <p>Scansiona per aprire Google My Maps:</p>
                            <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAKQAAACkCAYAAAAZtYVBAAAAAklEQVR4AewaftIAAAYTSURBVO3BQY4cSRLAQDLQ//8yV0c/JZCoailm4Wb2B2utKw5rrSsOa60rDmutKw5rrSsOa60rDmutKw5rrSsOa60rDmutKw5rrSsOa60rDmutKw5rrSt++JDK31QxqUwVk8pUMal8omJSmSomlW9STCqTylTxCZW/qeITh7XWFYe11hWHtdYVP3xZxTepTCpTxaQyVUwqU8WkMlVMKlPFpDJVTCpTxaQyVUwqU8Wk8k0V36TyTYe11hWHtdYVh7XWFT/8MpVPVEwqU8WkMlVMKlPFpDKpTBWTylQxqUwVk8pUMalMFZ9Q+UTFb1L5pMNa64rDWuuKw1rril/2P1YxqUwVk8pUMalMFZPKVDGpTBX/Zw5rrSsOa60rDmutK374j1GZKiaVqWJSmSomlaniEypTxaQyVUwqU8X/mcNa64rDWuuKw1rril/2ZSpTxaQyVUwqU8WkMlVMKlPFpDJVTCpTxaQyVUwqU8WkMlVMKlPFpDJVTCpTxW86rLWuOKy1rjista744cupTBWTylQxqUwVk8pUMalMFZPKVDGpTBWTylQxqUwVk8pUMalMFZPKVPGbVKaKSWWq+KbDWuuKw1rrisNa64ofPqQyVUwqU8WkMlVMKlPFpDJVTCpTxaQyVUwqU8UnVKaKSWWqmFSmikllqphUpopJZar4hMpU8U2HtdYVh7XWFYe11hU//LKKSWWqmFSmiknlEypTxaQyVUwqU8WkMlVMKlPFpDJVTCpTxaQyVUwqU8WkMlVMKlPFpDJVTCr/0mGtdcVhrXXFYa11xQ9fpvJNFZPKVDGpTBWTylQxqUwVk8pUMalMFZPKVDGpTBWTylQxqUwVk8pUMalMFZPKVDGpTBXfdFhrXXFYa11xWGtd8cOHKiaVqWJSmSomlU+oTBWTylQxqUwVk8pUMalMFZPKVDGpTBWTylQxqUwVk8pUMalMFZPKVDGpTBX/0mGtdcVhrXXFYa11xQ8fUpkqJpWpYlKZKiaVqWJSmSomlaliUpkqJpWpYlKZKiaVqWJSmSomlaniEypTxaQyVUwqU8WkMlV802GtdcVhrXXFYa11xQ9/WcWkMlVMKlPFpDJVTCpTxaQyVUwqU8WkMlVMKlPFpDJVTCpTxaQyVUwqU8WkMlVMKlPFpDJVfNNhrXXFYa11xWGtdcUPH1KZKiaVqWJSmSomlaliUpkqJpWpYlKZKiaVqWJSmSomlaliUpkqJpWpYlKZKiaVqWJSmSomlaniEypTxScOa60rDmutKw5rrSt++JDKVDGpTBWTylQxqUwVk8pUMalMFZPKVDGpTBWTylQxqUwVk8pUMalMFZPKVDGpTBWTylQxqUwVk8pU8U2HtdYVh7XWFYe11hU//GUqU8WkMlVMKlPFpDJVTCpTxaQyVUwqU8WkMlVMKlPFpDJVTCpTxaQyVUwqU8WkMlVMKlPFpDJVfNNhrXXFYa11xWGtdcUPH6qYVKaKSWWqmFQ+UTGpTBWTylQxqUwVk8pUMalMFZPKVDGpTBWTylQxqUwVk8pUMalMFZPKVDGpTBWfOKy1rjista44rLWu+OFDKn9TxaQyVUwqU8WkMlVMKlPFpDJVTCpTxaQyVUwqU8WkMlVMKlPFpDJVTCr/0mGtdcVhrXXFYa11xQ9fVvFNKlPFpDJVTCpTxaQyVUwqU8WkMlVMKlPFpDJVTCpTxaQyVUwqU8UnVL6p4hOHtdYVh7XWFYe11hU//DKVTyomlaliUpkqJpWpYlKZKiaVqWJSmSomlaliUpkqJpWp4hMqn6j4TYe11hWHtdYVh7XWFT/8x6hMFZPKVDGpTBWTylQxqUwVk8pUMalMFZPKVDGpTBX/ZQ5rrSsOa60rDmutK374H1OZKiaVqWJSmSomlaliUpkqJpWpYlKZKiaVqeKbVKaKbzqsta44rLWuOKy1rvhlX6YyVUwqU8WkMlVMKlPFpDJVTCpTxaQyVUwqU8WkMlVMKlPFpDJVTCpTxaTymw5rrSsOa60rDmutK374kMrfVDGpTBWTylQxqUwVk8pUMalMFZPKVDGpTBWTylQxqUwVk8pUMalMFZPK33RYa11xWGtdcVhrXWF/8Adr/VccvtJAhwAAAABJRU5ErkJggg==" alt="QR Code per Google My Maps">
                        </div>
                    </div>
                    
                    <div class="platform-instructions">
                        <div class="platform-title">Da smartphone Android</div>
                        <div class="instruction-step">Scarica il file GPX (più compatibile su Android)</div>
                        <div class="instruction-step">Installa un'app come "GPX Viewer" dal Play Store</div>
                        <div class="instruction-step">Apri l'app e importa il file GPX scaricato</div>
                    </div>
                    
                    <div class="platform-instructions">
                        <div class="platform-title">Da iPhone/iPad</div>
                        <div class="instruction-step">Scarica il file KML o GPX</div>
                        <div class="instruction-step">Apri l'app Mappe di Apple</div>
                        <div class="instruction-step">Tocca il file scaricato e seleziona "Apri in Mappe"</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Inizializzazione variabili globali
        let map;
        let points = [];
        let optimizedRoute = [];
        let routePolyline = null;
        let markers = [];
        let tempMarker = null;
        let geocodedPoint = null;
        
        // Inizializzazione della mappa
        function initMap() {
            map = L.map('map').setView([41.9028, 12.4964], 6); // Centro su Italia
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
        }
        
        // Funzione per sanitizzare l'input
        function sanitizeInput(input) {
            if (typeof input !== 'string') return '';
            return input.replace(/[<>&"'`=\/]/g, '');
        }
        
        // Validazione delle coordinate
        function validateCoordinates(lat, lon) {
            const latNum = parseFloat(lat);
            const lonNum = parseFloat(lon);
            
            if (isNaN(latNum) || isNaN(lonNum)) {
                showError("Le coordinate devono essere numeri validi.");
                return false;
            }
            
            if (latNum < -90 || latNum > 90) {
                showError("La latitudine deve essere compresa tra -90 e 90 gradi.");
                return false;
            }
            
            if (lonNum < -180 || lonNum > 180) {
                showError("La longitudine deve essere compresa tra -180 e 180 gradi.");
                return false;
            }
            
            return true;
        }
        
        // Mostra messaggi di errore
        function showError(message) {
            const errorBox = document.getElementById('error-box');
            errorBox.textContent = message;
            errorBox.style.display = 'block';
            
            // Auto-scomparsa dopo 5 secondi
            setTimeout(() => {
                errorBox.style.display = 'none';
            }, 5000);
        }
        
        // Mostra messaggi di successo
        function showSuccess(message) {
            const successBox = document.getElementById('success-box');
            successBox.textContent = message;
            successBox.style.display = 'block';
            
            // Auto-scomparsa dopo 5 secondi
            setTimeout(() => {
                successBox.style.display = 'none';
            }, 5000);
        }
        
        // Aggiunta di un punto
        function addPoint(name, lat, lon) {
            if (!validateCoordinates(lat, lon)) return;
            
            const sanitizedName = sanitizeInput(name);
            
            // Controllo se il punto esiste già
            const exists = points.some(p => 
                p.lat === parseFloat(lat) && 
                p.lon === parseFloat(lon) && 
                p.name === sanitizedName
            );
            
            if (exists) {
                showError("Questo punto esiste già.");
                return;
            }
            
            const point = {
                name: sanitizedName || `Punto ${points.length + 1}`,
                lat: parseFloat(lat),
                lon: parseFloat(lon)
            };
            
            points.push(point);
            updatePointsTable();
            updateStartPointDropdown();
            addMarkerToMap(point);
            
            // Reset dei campi
            document.getElementById('point-name').value = '';
            document.getElementById('point-lat').value = '';
            document.getElementById('point-lon').value = '';
            
            // Se c'era un percorso ottimizzato, rimuovilo
            if (routePolyline) {
                map.removeLayer(routePolyline);
                routePolyline = null;
                optimizedRoute = [];
                document.getElementById('result-info').classList.add('hidden');
                
                // Disabilita i pulsanti di esportazione
                document.getElementById('export-kml').disabled = true;
                document.getElementById('export-gpx').disabled = true;
                document.getElementById('show-export-help').disabled = true;
            }
            
            return point;
        }
        
        // Aggiornamento della tabella dei punti
        function updatePointsTable() {
            const tbody = document.querySelector('#points-table tbody');
            tbody.innerHTML = '';
            
            points.forEach((point, index) => {
                const row = document.createElement('tr');
                
                const nameCell = document.createElement('td');
                nameCell.textContent = point.name;
                
                const latCell = document.createElement('td');
                latCell.textContent = point.lat.toFixed(6);
                
                const lonCell = document.createElement('td');
                lonCell.textContent = point.lon.toFixed(6);
                
                const actionsCell = document.createElement('td');
                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Rimuovi';
                deleteButton.className = 'btn-danger';
                deleteButton.onclick = () => removePoint(index);
                actionsCell.appendChild(deleteButton);
                
                row.appendChild(nameCell);
                row.appendChild(latCell);
                row.appendChild(lonCell);
                row.appendChild(actionsCell);
                
                tbody.appendChild(row);
            });
        }
        
        // Aggiornamento del menu a discesa per il punto di partenza
        function updateStartPointDropdown() {
            const select = document.getElementById('start-point');
            const selectedValue = select.value; // Salva il valore selezionato
            
            select.innerHTML = '<option value="">Seleziona un punto di partenza</option>';
            
            points.forEach((point, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = point.name;
                
                // Se questo era il punto selezionato prima, selezionalo di nuovo
                if (selectedValue === index.toString()) {
                    option.selected = true;
                }
                
                select.appendChild(option);
            });
            
            // Se è stato appena aggiunto un nuovo punto e non c'era una selezione precedente,
            // seleziona automaticamente l'ultimo punto aggiunto
            if (!selectedValue && points.length > 0) {
                select.value = points.length - 1;
            }
        }
        
        // Rimozione di un punto
        function removePoint(index) {
            if (index >= 0 && index < points.length) {
                // Rimuovi il marker dalla mappa
                if (markers[index]) {
                    map.removeLayer(markers[index]);
                    markers.splice(index, 1);
                }
                
                points.splice(index, 1);
                updatePointsTable();
                updateStartPointDropdown();
                updateMarkers();
                
                // Se c'era un percorso ottimizzato, rimuovilo
                if (routePolyline) {
                    map.removeLayer(routePolyline);
                    routePolyline = null;
                    optimizedRoute = [];
                    document.getElementById('result-info').classList.add('hidden');
                    
                    // Disabilita i pulsanti di esportazione
                    document.getElementById('export-kml').disabled = true;
                    document.getElementById('export-gpx').disabled = true;
                    document.getElementById('show-export-help').disabled = true;
                }
            }
        }
        
        // Aggiunta di un marker alla mappa
        function addMarkerToMap(point) {
            const marker = L.marker([point.lat, point.lon])
                .addTo(map)
                .bindPopup(`<b>${point.name}</b><br>Lat: ${point.lat.toFixed(6)}<br>Lon: ${point.lon.toFixed(6)}`);
            
            markers.push(marker);
            
            // Centra la mappa sul nuovo punto
            map.setView([point.lat, point.lon], 10);
        }
        
        // Aggiornamento dei marker sulla mappa
        function updateMarkers() {
            // Rimuovi tutti i marker esistenti
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            // Aggiungi nuovamente i marker per tutti i punti
            points.forEach(point => {
                addMarkerToMap(point);
            });
        }
        
        // Calcolo della distanza tra due punti (formula di Haversine)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Raggio della Terra in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        // Algoritmo Nearest Neighbor per soluzione iniziale
        function nearestNeighborTSP(points, startIndex) {
            const numPoints = points.length;
            if (numPoints <= 1) return [0];
            
            const visited = new Array(numPoints).fill(false);
            const route = [];
            let currentIndex = startIndex;
            
            route.push(currentIndex);
            visited[currentIndex] = true;
            
            // Trova il punto più vicino non visitato
            for (let i = 1; i < numPoints; i++) {
                let minDist = Infinity;
                let nextIndex = -1;
                
                for (let j = 0; j < numPoints; j++) {
                    if (!visited[j]) {
                        const dist = calculateDistance(
                            points[currentIndex].lat, points[currentIndex].lon,
                            points[j].lat, points[j].lon
                        );
                        
                        if (dist < minDist) {
                            minDist = dist;
                            nextIndex = j;
                        }
                    }
                }
                
                if (nextIndex !== -1) {
                    route.push(nextIndex);
                    visited[nextIndex] = true;
                    currentIndex = nextIndex;
                }
            }
            
            // Aggiungi il punto di partenza per chiudere il percorso
            route.push(startIndex);
            
            return route;
        }
        
        // Algoritmo 2-Opt per miglioramento iterativo
        function twoOptImprovement(points, route) {
            let improved = true;
            let bestDistance = calculateTotalDistance(points, route);
            
            while (improved) {
                improved = false;
                
                for (let i = 1; i < route.length - 2; i++) {
                    for (let j = i + 1; j < route.length - 1; j++) {
                        // Scambia i segmenti del percorso
                        const newRoute = twoOptSwap(route, i, j);
                        const newDistance = calculateTotalDistance(points, newRoute);
                        
                        if (newDistance < bestDistance) {
                            route = newRoute;
                            bestDistance = newDistance;
                            improved = true;
                        }
                    }
                }
            }
            
            return route;
        }
        
        // Funzione di supporto per 2-Opt: scambia i segmenti del percorso
        function twoOptSwap(route, i, j) {
            const newRoute = route.slice(0, i);
            
            // Inverti il segmento tra i e j
            for (let k = j; k >= i; k--) {
                newRoute.push(route[k]);
            }
            
            // Aggiungi il resto del percorso
            for (let k = j + 1; k < route.length; k++) {
                newRoute.push(route[k]);
            }
            
            return newRoute;
        }
        
        // Calcolo della distanza totale del percorso
        function calculateTotalDistance(points, route) {
            let totalDistance = 0;
            
            for (let i = 0; i < route.length - 1; i++) {
                const p1 = points[route[i]];
                const p2 = points[route[i + 1]];
                totalDistance += calculateDistance(p1.lat, p1.lon, p2.lat, p2.lon);
            }
            
            return totalDistance;
        }
        
        // Ottimizzazione del percorso
        function optimizeRoute() {
            if (points.length < 2) {
                showError("Inserisci almeno 2 punti per ottimizzare il percorso.");
                return;
            }
            
            const startPointSelect = document.getElementById('start-point');
            if (!startPointSelect.value) {
                showError("Seleziona un punto di partenza.");
                return;
            }
            
            const startIndex = parseInt(startPointSelect.value);
            
            // Algoritmo Nearest Neighbor per soluzione iniziale
            let route = nearestNeighborTSP(points, startIndex);
            
            // Miglioramento con 2-Opt
            route = twoOptImprovement(points, route);
            
            optimizedRoute = route;
            
            // Visualizza il percorso sulla mappa
            displayRouteOnMap();
            
            // Calcola e mostra la distanza totale
            const totalDistance = calculateTotalDistance(points, route);
            document.getElementById('total-distance').textContent = totalDistance.toFixed(2);
            document.getElementById('result-info').classList.remove('hidden');
            
            // Abilita i pulsanti di esportazione
            document.getElementById('export-kml').disabled = false;
            document.getElementById('export-gpx').disabled = false;
            document.getElementById('show-export-help').disabled = false;
            
            showSuccess("Percorso ottimizzato con successo!");
        }
        
        // Visualizzazione del percorso sulla mappa
        function displayRouteOnMap() {
            // Rimuovi il percorso precedente se esiste
            if (routePolyline) {
                map.removeLayer(routePolyline);
            }
            
            // Crea un array di coordinate per il percorso
            const routeCoordinates = optimizedRoute.map(index => [points[index].lat, points[index].lon]);
            
            // Crea una polyline per il percorso
            routePolyline = L.polyline(routeCoordinates, {
                color: '#3498db',
                weight: 5,
                opacity: 0.7
            }).addTo(map);
            
            // Aggiorna i popup dei marker per mostrare l'ordine
            markers.forEach((marker, i) => {
                const orderIndex = optimizedRoute.indexOf(i);
                if (orderIndex !== -1) {
                    const point = points[i];
                    marker.bindPopup(
                        `<b>${point.name}</b><br>` +
                        `Ordine: ${orderIndex === optimizedRoute.length - 1 ? 'Fine (ritorno)' : orderIndex + 1}<br>` +
                        `Lat: ${point.lat.toFixed(6)}<br>` +
                        `Lon: ${point.lon.toFixed(6)}`
                    );
                }
            });
            
            // Adatta la vista della mappa per mostrare tutto il percorso
            map.fitBounds(routePolyline.getBounds(), { padding: [50, 50] });
        }
        
        // Genera file KML per Google Maps
        function generateKML() {
            if (optimizedRoute.length === 0) {
                showError("Ottimizza prima il percorso per poterlo esportare in KML.");
                return null;
            }
            
            // Intestazione KML
            let kml = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
  <Document>
    <name>TAF Route Optimizer - Percorso Ottimizzato</name>
    <description>Percorso ottimizzato generato da TAF Route Optimizer</description>
    
    <!-- Stili per i punti -->
    <Style id="startPointStyle">
      <IconStyle>
        <color>ff00ff00</color>
        <scale>1.2</scale>
        <Icon>
          <href>http://maps.google.com/mapfiles/kml/paddle/grn-circle.png</href>
        </Icon>
      </IconStyle>
    </Style>
    
    <Style id="endPointStyle">
      <IconStyle>
        <color>ff0000ff</color>
        <scale>1.2</scale>
        <Icon>
          <href>http://maps.google.com/mapfiles/kml/paddle/red-circle.png</href>
        </Icon>
      </IconStyle>
    </Style>
    
    <Style id="waypointStyle">
      <IconStyle>
        <color>ffff0000</color>
        <scale>1.0</scale>
        <Icon>
          <href>http://maps.google.com/mapfiles/kml/paddle/blu-circle.png</href>
        </Icon>
      </IconStyle>
    </Style>
    
    <Style id="lineStyle">
      <LineStyle>
        <color>ff0000ff</color>
        <width>4</width>
      </LineStyle>
    </Style>
    
    <!-- Percorso come linea -->
    <Placemark>
      <name>Percorso Ottimizzato</name>
      <styleUrl>#lineStyle</styleUrl>
      <LineString>
        <tessellate>1</tessellate>
        <coordinates>`;
            
            // Aggiungi le coordinate del percorso (lon,lat,0 è il formato KML)
            for (const index of optimizedRoute) {
                const point = points[index];
                kml += `${point.lon},${point.lat},0\n`;
            }
            
            kml += `        </coordinates>
      </LineString>
    </Placemark>
    
    <!-- Punti del percorso -->`;
            
            // Aggiungi i punti come placemark
            optimizedRoute.forEach((index, i) => {
                const point = points[index];
                let styleUrl;
                
                if (i === 0) {
                    styleUrl = "#startPointStyle";
                } else if (i === optimizedRoute.length - 1) {
                    styleUrl = "#endPointStyle";
                } else {
                    styleUrl = "#waypointStyle";
                }
                
                const orderLabel = i === optimizedRoute.length - 1 ? 'Fine (ritorno)' : i + 1;
                
                kml += `
    <Placemark>
      <name>${point.name}</name>
      <description>Ordine: ${orderLabel}\nLat: ${point.lat}\nLon: ${point.lon}</description>
      <styleUrl>${styleUrl}</styleUrl>
      <Point>
        <coordinates>${point.lon},${point.lat},0</coordinates>
      </Point>
    </Placemark>`;
            });
            
            // Chiudi il documento KML
            kml += `
  </Document>
</kml>`;
            
            return kml;
        }
        
        // Genera file GPX
        function generateGPX() {
            if (optimizedRoute.length === 0) {
                showError("Ottimizza prima il percorso per poterlo esportare in GPX.");
                return null;
            }
            
            // Intestazione GPX
            let gpx = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="TAF Route Optimizer" xmlns="http://www.topografix.com/GPX/1/1">
  <metadata>
    <name>Percorso Ottimizzato TAF</name>
    <desc>Percorso ottimizzato generato da TAF Route Optimizer</desc>
    <time>${new Date().toISOString()}</time>
  </metadata>
  
  <!-- Traccia del percorso -->
  <trk>
    <name>Percorso Ottimizzato</name>
    <trkseg>`;
            
            // Aggiungi i punti della traccia
            for (const index of optimizedRoute) {
                const point = points[index];
                gpx += `
      <trkpt lat="${point.lat}" lon="${point.lon}">
        <ele>0</ele>
      </trkpt>`;
            }
            
            gpx += `
    </trkseg>
  </trk>
  
  <!-- Waypoints -->`;
            
            // Aggiungi i waypoints
            optimizedRoute.forEach((index, i) => {
                const point = points[index];
                const orderLabel = i === optimizedRoute.length - 1 ? 'Fine (ritorno)' : i + 1;
                
                gpx += `
  <wpt lat="${point.lat}" lon="${point.lon}">
    <name>${point.name}</name>
    <desc>Ordine: ${orderLabel}</desc>
  </wpt>`;
            });
            
            // Chiudi il documento GPX
            gpx += `
</gpx>`;
            
            return gpx;
        }
        
        // Mostra il modal di esportazione
        function showExportModal(activeTab = 'kml-tab') {
            // Genera i contenuti
            const kml = generateKML();
            const gpx = generateGPX();
            
            if (!kml || !gpx) return;
            
            // Imposta i contenuti nelle textarea
            document.getElementById('kml-textarea').value = kml;
            document.getElementById('gpx-textarea').value = gpx;
            
            // Attiva la tab richiesta
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
                if (button.getAttribute('data-tab') === activeTab) {
                    button.classList.add('active');
                }
            });
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
                if (content.id === activeTab) {
                    content.classList.add('active');
                }
            });
            
            // Mostra il modal
            document.getElementById('export-modal').style.display = 'block';
        }
        
        // Chiudi il modal di esportazione
        function closeExportModal() {
            document.getElementById('export-modal').style.display = 'none';
        }
        
        // Copia il contenuto negli appunti
        function copyToClipboard(textareaId) {
            const textarea = document.getElementById(textareaId);
            textarea.select();
            
            try {
                document.execCommand('copy');
                showSuccess("Contenuto copiato negli appunti!");
            } catch (err) {
                showError("Impossibile copiare il testo: " + err);
            }
        }
        
        // Scarica il file
        function downloadFile(content, filename, mimeType) {
            if (!content) {
                showError("Nessun contenuto da scaricare.");
                return;
            }
            
            // Crea un elemento <a> per il download
            const element = document.createElement('a');
            element.setAttribute('href', 'data:' + mimeType + ';charset=utf-8,' + encodeURIComponent(content));
            element.setAttribute('download', filename);
            
            // Nascondi l'elemento
            element.style.display = 'none';
            document.body.appendChild(element);
            
            // Simula il click e rimuovi l'elemento
            element.click();
            document.body.removeChild(element);
            
            showSuccess(`File ${filename} scaricato con successo!`);
        }
        
        // Importa punti da file CSV
        function importCSV(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const content = e.target.result;
                const lines = content.split('\n');
                
                // Salta l'intestazione
                let skippedHeader = false;
                let importedCount = 0;
                
                for (const line of lines) {
                    if (!skippedHeader) {
                        skippedHeader = true;
                        continue;
                    }
                    
                    const trimmedLine = line.trim();
                    if (!trimmedLine) continue;
                    
                    const parts = trimmedLine.split(',');
                    if (parts.length >= 3) {
                        const name = parts[0].trim();
                        const lat = parseFloat(parts[1]);
                        const lon = parseFloat(parts[2]);
                        
                        if (!isNaN(lat) && !isNaN(lon)) {
                            addPoint(name, lat, lon);
                            importedCount++;
                        }
                    }
                }
                
                if (importedCount > 0) {
                    showSuccess(`Importati ${importedCount} punti dal file CSV.`);
                } else {
                    showError("Nessun punto valido trovato nel file CSV.");
                }
            };
            
            reader.readAsText(file);
        }
        
        // Geocodifica un indirizzo usando Nominatim
        async function geocodeAddress(address) {
            try {
                const sanitizedAddress = sanitizeInput(address);
                const encodedAddress = encodeURIComponent(sanitizedAddress);
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodedAddress}&limit=1`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.length > 0) {
                    const result = data[0];
                    const lat = parseFloat(result.lat);
                    const lon = parseFloat(result.lon);
                    const fullAddress = result.display_name; // Usa l'indirizzo completo
                    
                    // Salva il punto geocodificato
                    geocodedPoint = {
                        name: fullAddress, // Usa l'indirizzo completo come nome
                        lat: lat,
                        lon: lon
                    };
                    
                    // Aggiorna i campi del form
                    document.getElementById('point-name').value = fullAddress;
                    document.getElementById('point-lat').value = lat;
                    document.getElementById('point-lon').value = lon;
                    
                    // Centra la mappa sul risultato
                    map.setView([lat, lon], 15);
                    
                    // Rimuovi il marker temporaneo precedente se esiste
                    if (tempMarker) {
                        map.removeLayer(tempMarker);
                    }
                    
                    // Crea un marker temporaneo
                    tempMarker = L.marker([lat, lon])
                        .addTo(map)
                        .bindPopup(`<b>${fullAddress}</b><br>Lat: ${lat}<br>Lon: ${lon}<br><i>Clicca "Aggiungi Punto Geocodificato" per salvare</i>`)
                        .openPopup();
                    
                    // Abilita il pulsante per aggiungere il punto geocodificato
                    document.getElementById('add-geocoded-point').disabled = false;
                    
                    showSuccess("Indirizzo trovato! Clicca 'Aggiungi Punto Geocodificato' per salvarlo.");
                } else {
                    showError("Indirizzo non trovato. Prova con un indirizzo più specifico.");
                    geocodedPoint = null;
                    document.getElementById('add-geocoded-point').disabled = true;
                }
            } catch (error) {
                showError("Errore durante la geocodifica: " + error.message);
                geocodedPoint = null;
                document.getElementById('add-geocoded-point').disabled = true;
            }
        }
        
        // Aggiungi il punto geocodificato
        function addGeocodedPoint() {
            if (geocodedPoint) {
                const point = addPoint(geocodedPoint.name, geocodedPoint.lat, geocodedPoint.lon);
                
                // Rimuovi il marker temporaneo
                if (tempMarker) {
                    map.removeLayer(tempMarker);
                    tempMarker = null;
                }
                
                // Disabilita il pulsante
                document.getElementById('add-geocoded-point').disabled = true;
                
                // Pulisci il campo dell'indirizzo
                document.getElementById('address').value = '';
                
                // Seleziona automaticamente il punto appena aggiunto come punto di partenza
                if (point) {
                    const startPointSelect = document.getElementById('start-point');
                    startPointSelect.value = points.length - 1;
                }
                
                geocodedPoint = null;
                
                showSuccess("Punto geocodificato aggiunto con successo!");
            }
        }
        
        // Ottieni la posizione GPS dell'utente
        function getUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        
                        document.getElementById('point-name').value = 'Posizione Attuale';
                        document.getElementById('point-lat').value = lat;
                        document.getElementById('point-lon').value = lon;
                        
                        // Centra la mappa sulla posizione
                        map.setView([lat, lon], 15);
                        
                        showSuccess("Posizione GPS acquisita con successo!");
                    },
                    (error) => {
                        let errorMsg;
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMsg = "Accesso alla posizione negato dall'utente.";
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMsg = "Informazioni sulla posizione non disponibili.";
                                break;
                            case error.TIMEOUT:
                                errorMsg = "Richiesta di posizione scaduta.";
                                break;
                            default:
                                errorMsg = "Errore sconosciuto durante l'acquisizione della posizione.";
                        }
                        showError(errorMsg);
                    }
                );
            } else {
                showError("La geolocalizzazione non è supportata dal tuo browser.");
            }
        }
        
        // Inizializzazione degli event listener
        function initEventListeners() {
            // Aggiungi punto manualmente
            document.getElementById('add-point').addEventListener('click', () => {
                const name = document.getElementById('point-name').value;
                const lat = document.getElementById('point-lat').value;
                const lon = document.getElementById('point-lon').value;
                addPoint(name, lat, lon);
            });
            
            // Usa posizione GPS
            document.getElementById('add-gps').addEventListener('click', getUserLocation);
            
            // Geocodifica indirizzo
            document.getElementById('geocode-address').addEventListener('click', () => {
                const address = document.getElementById('address').value;
                if (address.trim()) {
                    geocodeAddress(address);
                } else {
                    showError("Inserisci un indirizzo da geocodificare.");
                }
            });
            
            // Aggiungi punto geocodificato
            document.getElementById('add-geocoded-point').addEventListener('click', addGeocodedPoint);
            
            // Ottimizza percorso
            document.getElementById('optimize-route').addEventListener('click', optimizeRoute);
            
            // Importa CSV
            document.getElementById('csv-file').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    importCSV(file);
                }
            });
            
            // Esporta KML
            document.getElementById('export-kml').addEventListener('click', () => {
                showExportModal('kml-tab');
            });
            
            // Esporta GPX
            document.getElementById('export-gpx').addEventListener('click', () => {
                showExportModal('gpx-tab');
            });
            
            // Mostra guida all'importazione
            document.getElementById('show-export-help').addEventListener('click', () => {
                showExportModal('help-tab');
            });
            
            // Chiudi modal
            document.getElementById('close-export-modal').addEventListener('click', closeExportModal);
            
            // Gestione delle tab nel modal
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.getAttribute('data-tab');
                    
                    // Attiva il pulsante
                    document.querySelectorAll('.tab-button').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    button.classList.add('active');
                    
                    // Mostra il contenuto della tab
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(tabId).classList.add('active');
                });
            });
            
            // Copia KML negli appunti
            document.getElementById('copy-kml').addEventListener('click', () => {
                copyToClipboard('kml-textarea');
            });
            
            // Scarica file KML
            document.getElementById('download-kml').addEventListener('click', () => {
                const kml = document.getElementById('kml-textarea').value;
                downloadFile(kml, 'percorso_ottimizzato.kml', 'application/vnd.google-earth.kml+xml');
            });
            
            // Copia GPX negli appunti
            document.getElementById('copy-gpx').addEventListener('click', () => {
                copyToClipboard('gpx-textarea');
            });
            
            // Scarica file GPX
            document.getElementById('download-gpx').addEventListener('click', () => {
                const gpx = document.getElementById('gpx-textarea').value;
                downloadFile(gpx, 'percorso_ottimizzato.gpx', 'application/gpx+xml');
            });
            
            // Chiudi il modal quando si clicca fuori
            window.addEventListener('click', (e) => {
                const modal = document.getElementById('export-modal');
                if (e.target === modal) {
                    closeExportModal();
                }
            });
            
            // Aggiungi anche l'evento per premere Invio nel campo indirizzo
            document.getElementById('address').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const address = document.getElementById('address').value;
                    if (address.trim()) {
                        geocodeAddress(address);
                    } else {
                        showError("Inserisci un indirizzo da geocodificare.");
                    }
                }
            });
        }
        
        // Inizializzazione dell'applicazione
        function init() {
            initMap();
            initEventListeners();
        }
        
        // Avvia l'applicazione quando il DOM è caricato
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>