<!-- Aggiunta a fine body del file HTML per completare le funzioni mancanti -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    inizializzaMappa();
    document.getElementById('fileInput').addEventListener('change', leggiCSV);
  });

  function leggiCSV(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function (e) {
      const lines = e.target.result.split(/\r?\n/);
      lines.forEach(line => {
        const [nome, lat, lon] = line.split(',');
        if (nome && lat && lon) {
          aggiungiPunto(nome, lat, lon, false);
        }
      });
      aggiornaTabella();
      disegnaPercorso(punti);
    };
    reader.readAsText(file);
  }

  function aggiungiPuntoUI() {
    const nome = document.getElementById('nome').value;
    const lat = document.getElementById('lat').value;
    const lon = document.getElementById('long').value;
    if (aggiungiPunto(nome, lat, lon)) {
      aggiornaTabella();
      disegnaPercorso(punti);
    }
  }

  function aggiungiPunto(nome, lat, lon, fromUI = true) {
    if (!nome || nome.trim() === '') {
      if (fromUI) mostraErrore('Il nome del punto √® obbligatorio');
      return false;
    }
    const validation = validaCoordinate(lat, lon);
    if (!validation.valid) {
      if (fromUI) mostraErrore(validation.error);
      return false;
    }
    punti.push({ nome: sanitizeInput(nome), lat: validation.lat, lon: validation.lon });
    aggiornaTabella();
    return true;
  }

  function aggiungiMiaPosizione() {
    if (!navigator.geolocation) {
      mostraErrore("Il browser non supporta la geolocalizzazione.");
      return;
    }
    navigator.geolocation.getCurrentPosition(pos => {
      const { latitude, longitude } = pos.coords;
      const nome = "Posizione Attuale";
      if (aggiungiPunto(nome, latitude, longitude)) {
        aggiornaTabella();
        disegnaPercorso(punti);
      }
    }, err => {
      mostraErrore("Impossibile ottenere la posizione: " + err.message);
    });
  }

  async function geocodificaIndirizzo() {
    const indirizzo = document.getElementById("indirizzo").value.trim();
    if (!indirizzo) {
      mostraErrore("Inserisci un indirizzo valido.");
      return;
    }
    try {
      const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(indirizzo)}`);
      const data = await response.json();
      if (data && data.length > 0) {
        const { lat, lon, display_name } = data[0];
        if (aggiungiPunto(display_name, lat, lon)) {
          aggiornaTabella();
          disegnaPercorso(punti);
        }
      } else {
        mostraErrore("Indirizzo non trovato.");
      }
    } catch (err) {
      mostraErrore("Errore nella geocodifica dell'indirizzo.");
    }
  }

  function resetPunti() {
    punti.length = 0;
    aggiornaTabella();
    pulisciMappa();
  }

  function rimuoviPunto(index) {
    punti.splice(index, 1);
    aggiornaTabella();
    disegnaPercorso(punti);
  }

  function calcolaPercorso() {
    if (punti.length < 2) {
      mostraErrore("Inserisci almeno due punti per calcolare il percorso.");
      return;
    }
    const select = document.getElementById('puntoPartenza');
    const index = select ? parseInt(select.value) : 0;
    const orderedPunti = punti.slice(index).concat(punti.slice(0, index));
    isCalculating = true;
    document.getElementById('loading').style.display = 'block';
    setTimeout(() => {
      let percorso = tspNearestNeighbor(orderedPunti);
      percorso = tsp2Opt(percorso);
      percorsoOttimizzato = percorso;
      aggiornaTabella();
      disegnaPercorso(percorso);
      mostraStatistiche(percorso);
      document.getElementById('loading').style.display = 'none';
      isCalculating = false;
    }, 100);
  }

  function mostraStatistiche(percorso) {
    const stats = document.getElementById("stats");
    const distanza = calcolaDistanzaTotale(percorso).toFixed(2);
    stats.innerHTML = `<h4>üìè Statistiche Percorso</h4><p>Totale: ${distanza} km</p>`;
    stats.style.display = 'block';
  }

  function esportaCSV() {
    if (percorsoOttimizzato.length === 0) return;
    const csv = ["nome,lat,lon"];
    percorsoOttimizzato.forEach(p => {
      csv.push(`${p.nome},${p.lat},${p.lon}`);
    });
    downloadFile(csv.join("\n"), 'percorso.csv', 'text/csv');
  }

  function esportaKML() {
    if (percorsoOttimizzato.length === 0) return;
    let kml = `<?xml version="1.0" encoding="UTF-8"?>\n<kml xmlns="http://www.opengis.net/kml/2.2">\n<Document>\n`;
    percorsoOttimizzato.forEach(p => {
      kml += `<Placemark><name>${p.nome}</name><Point><coordinates>${p.lon},${p.lat},0</coordinates></Point></Placemark>\n`;
    });
    kml += `</Document></kml>`;
    downloadFile(kml, 'percorso.kml', 'application/vnd.google-earth.kml+xml');
  }

  function esportaGPX() {
    if (percorsoOttimizzato.length === 0) return;
    let gpx = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>\n<gpx version="1.1" creator="TSP Optimizer" xmlns="http://www.topografix.com/GPX/1/1">\n<trk><name>Percorso Ottimizzato</name><trkseg>\n`;
    percorsoOttimizzato.forEach(p => {
      gpx += `<trkpt lat="${p.lat}" lon="${p.lon}"><name>${p.nome}</name></trkpt>\n`;
    });
    gpx += `</trkseg></trk></gpx>`;
    downloadFile(gpx, 'percorso.gpx', 'application/gpx+xml');
  }

  function downloadFile(content, filename, mimeType) {
    const blob = new Blob([content], { type: mimeType });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function caricaCSVEsempio() {
    const esempio = "nome,lat,lon\nMilano,45.4642,9.19\nBergamo,45.6983,9.6773\nBrescia,45.5416,10.2118";
    const blob = new Blob([esempio], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'esempio.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }
</script>