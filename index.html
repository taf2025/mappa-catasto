entById('newPointLat').value);
const lon = parseFloat(document.getElementById('newPointLon').value);

if (!name || isNaN(lat) || isNaN(lon) || lat < -90 || lat > 90 || lon < -180 || lon > 180) {
showError('Input non valido. Controlla le coordinate e riprova.');
return;
}

points.push({ name, lat, lon });
updatePointsTable();
addMarker(lat, lon, name);
showSuccess('Punto aggiunto con successo!');
});

function addMarker(lat, lon, name) {
const marker = L.marker([lat, lon]).addTo(map).bindPopup(name);
}

function updatePointsTable() {
const tableBody = document.querySelector('#pointsTable tbody');
tableBody.innerHTML = '';
points.forEach((point, index) => {
const row = tableBody.insertRow();
row.insertCell(0).textContent = point.name;
row.insertCell(1).textContent = point.lat;
row.insertCell(2).textContent = point.lon;
const removeCell = row.insertCell(3);
const removeButton = document.createElement('button');
removeButton.textContent = 'Rimuovi';
removeButton.onclick = () => {
points.splice(index, 1);
updatePointsTable();
};
removeCell.appendChild(removeButton);
});
updateStartPointSelect();
}

function updateStartPointSelect() {
const select = document.getElementById('startPointSelect');
select.innerHTML = '';
points.forEach((point, index) => {
const option = document.createElement('option');
option.value = index;
option.textContent = point.name;
select.appendChild(option);
});
}

document.getElementById('addUserLocation').addEventListener('click', () => {
navigator.geolocation.getCurrentPosition(position => {
const lat = position.coords.latitude;
const lon = position.coords.longitude;
document.getElementById('newPointLat').value = lat;
document.getElementById('newPointLon').value = lon;
});
});

document.getElementById('geocodeAddress').addEventListener('click', () => {
const address = sanitizeInput(document.getElementById('addressInput').value);
fetch(https://nominatim.openstreetmap.org/search?q=${address}&format=json&addressdetails=1)
.then(response => response.json())
.then(data => {
if (data.length > 0) {
const { lat, lon } = data[0];
document.getElementById('newPointLat').value = lat;
document.getElementById('newPointLon').value = lon;
} else {
showError('Indirizzo non trovato.');
}
})
.catch(() => showError('Errore nel geocoding.'));
});

document.getElementById('calculateRoute').addEventListener('click', () => {
if (points.length === 0) {
showError('Nessun punto disponibile per calcolare il percorso.');
return;
}

const startIndex = parseInt(document.getElementById('startPointSelect').value);
const startPoint = points[startIndex];

const route = calculateRoute(points, startPoint);
displayRoute(route);
});

function calculateRoute(points, startPoint) {
// Implementazione Nearest Neighbor e 2-Opt qui
// Restituisce un array di punti nell'ordine ottimale
return points; // Placeholder - sostituire con implementazione javaScript.
}

function displayRoute(route) {
const routeCoords = route.map(point => [point.lat, point.lon]);
const path = L.polyline(routeCoords, { color: 'red' }).addTo(map);
const distance = path.getDistance() / 1000; // Converti a km
document.getElementById('result').textContent = Distanza totale: ${distance.toFixed(2)} km;
}